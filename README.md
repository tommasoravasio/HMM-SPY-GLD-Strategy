# Regime-Aware SPY / GLD Allocation with Hidden Markov Models

Probabilistic tactical allocation between US equities (SPY) and Gold (GLD) using rolling Hidden Markov Models (HMM). The notebook implements and compares:

1. Gaussian HMM (2 latent regimes) on weekly SPY returns.
2. GMM-HMM (mixture emissions) to capture fat tails and multiâ€‘modality.
3. Bivariate GMM-HMM adding a realized volatility feature.
4. Dividend / total-return benchmark comparison using `^SP500TR`.

Goal: Improve drawdown profile and risk-adjusted returns (Sharpe) versus long-only SPY and a naive 50/50 static SPY/GLD blend, while retaining interpretability (two macro regimes: riskâ€‘on vs riskâ€‘off).

---
## ğŸ” Core Idea
Equity returns are generated by latent market regimes. If we can infer the probability of transitioning into / being in a stressed regime, we can size a defensive allocation (GLD) proportionally to that probability instead of binary switching. This smooth hedge aims to cut downside while preserving compounding.

---
## ğŸ“ Repository Contents
| Path | Description |
|------|-------------|
| `hmm_strategy.ipynb` | Endâ€‘toâ€‘end research notebook (data -> models -> evaluation). |
| `data/spy_data.csv` / `data/gld_data.csv` | Cached daily OHLCV downloads (yfinance). |
| `data/sp500_total_return.csv` | S&P 500 Total Return index (proxy for dividendâ€‘adjusted SPY). |
| `requirements.txt` | Minimal dependency list (extend as below). |

---
## ğŸ§ª Methodology Highlights
1. Download / cache daily SPY & GLD data (2000â€‘01â€‘01 onward) via `yfinance`; resample to weekly (Friday close) to reduce noise.
2. Compute weekly log returns; merge assets on common dates.
3. Rolling walkâ€‘forward estimation window: 104 weeks (~2 years) to refit HMM each step (mitigates lookâ€‘ahead bias).
4. Infer posterior state probabilities for last inâ€‘window observation; propagate one step using `pi_next = pi_t @ transmat_`.
5. Identify â€œhigh riskâ€ state as the one with lower historical mean SPY return inside the rolling window.
6. Allocate weight to GLD = predicted probability of highâ€‘risk state; remaining weight to SPY.
7. Compute portfolio return using log of weighted gross returns (avoids linear approximation bias): `log(w_spy * exp(r_spy) + w_gld * exp(r_gld))`.
8. Evaluate vs SPY, GLD, and a rebalanced 50/50 mix on: CAGR, Max Drawdown, Avg Drawdown, Sharpe (rf=0 simplification).
9. Upgrade Gaussian emissions to mixture (GMM-HMM) for tail fit; test bivariate feature (rolling vol) â€“ retained only if performance improves.
10. Stress benchmark by switching SPY price returns to total return proxy.

---
## ğŸ“Š Key Findings (Qualitative Summary)
You should reâ€‘run to reproduce numbers; indicative outcomes from development:

| Model | Sharpe | Max DD | Notes |
|-------|--------|--------|-------|
| Gaussian HMM | â†‘ vs SPY | â†“ | Improves drawdowns with moderate CAGR tradeâ€‘off. |
| GMM-HMM (univariate) | Best balance | â†“ further | Mixture emissions stabilize regime probabilities. |
| Bivariate GMM-HMM | No gain | Similar | Added noisy vol feature didnâ€™t help (short window). |
| 50/50 Static | Stable | Mid | Tough naive benchmark; strategy must beat risk/return efficiency. |

Conclusion: Univariate GMM-HMM offers best simplicity/performance tradeâ€‘off in this iteration.

---
## ğŸš€ Quick Start
Clone & install (recommend Python 3.10+):

```bash
git clone https://github.com/tommasoravasio/HMM-SPY-GLD-Strategy.git
cd HMM-SPY-GLD-Strategy
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

Open `hmm_strategy.ipynb` and run all cells. First run will download and cache data into `data/`.

### Recommended Additional Dependencies
The minimal `requirements.txt` only lists a subset. If missing, install:
```bash
pip install numpy matplotlib hmmlearn scikit-learn
```

Optional efficiency / quality:
```bash
pip install pandas-datareader tabulate
```

---
## ğŸ§© Model Design Choices
| Aspect | Choice | Rationale |
|--------|--------|-----------|
| Regimes | 2 | Interpretability (risk-on / risk-off). |
| Window | 104 weeks | Balance adaptation vs statistical stability. |
| Emissions | Gaussian â†’ GMM (n_mix=3) | Capture fat tails & skew without extra regimes. |
| Allocation | Prob(weight of stress) | Smooth hedge sizing; avoids whipsaw of hard switches. |
| Feature set | Returns (+ optional vol) | Start simple; vol feature deferred due to limited gain. |

---
## ğŸ›¡ï¸ Risk & Limitations
* Transaction costs, taxes, slippage excluded (weekly turnover could erode edge).
* Hyperparameters not optimized (no BIC / grid search yet).
* Regime economic labeling (link to macro variables) not validated.
* Survivorship: ETFs used directly; acceptable for research but production may prefer total return index series throughout.
* Single defensive asset (GLD); diversification breadth limited.

---
## ğŸ”„ Planned / Suggested Enhancements
Short term:
* Grid search (states âˆˆ {2,3}, n_mix âˆˆ {2,3,4}, window âˆˆ {78,104,130}) with BIC & outâ€‘ofâ€‘sample holdout.
* Regime persistence diagnostics (expected duration, entropy) & stability plots.
* Turnover / transaction cost modeling (e.g., 2â€“5 bps per rebalance).
* Weight change throttling (e.g., cap Î”weight â‰¤ 10% per week).

Medium term:
* Alternative/orthogonal features: VIX levels, term spread, credit spreads, liquidity proxies.
* Sticky / hierarchical / Markov-switching volatility extensions.
* Production refactor: move logic into modular Python package with tests & CLI.

---
## ğŸ§ª Reproducibility Notes
Random seeds set (e.g., `random_state=1806`) for HMM fitting, but EM can still introduce minor numerical variance across library versions. Pin dependency versions for strict reproducibility if publishing.

Example version pinning (adapt as needed):
```text
pandas==2.2.2
numpy==1.26.4
hmmlearn==0.3.2
scikit-learn==1.4.2
matplotlib==3.8.4
yfinance==0.2.40
```

---
## ğŸ“ˆ Interpreting Outputs
Key DataFrame columns (see notebook):
* `Strategy_Return_*` â€“ Weekly log portfolio return.
* `Cumulative_*` â€“ Cumulative growth of $1 initial capital.
* `GLD_Weight` â€“ Hedge allocation derived from predicted stress regime probability.
* Performance report â€“ Aggregated metrics via helper `compute_stats`.

---
## ğŸ§ª Metric Definitions
* CAGR: `(Final_Value)^(1/Years) - 1` using weekly compounding.
* Max Drawdown: Min of (Equity / Peak - 1).
* Average Drawdown: Mean of negative drawdown observations.
* Sharpe (simplified): `mean(weekly_return) / std(weekly_return) * sqrt(52)`; rf assumed 0.

---
## ğŸ“Œ Assumptions & Justifications
* Using log returns â†’ exact aggregation over time and avoids bias from arithmetic approximation when mixing assets.
* Two regimes chosen to trade interpretability over potentially higher raw Sharpe from more states (risk of regime proliferation / overfit).
* Weekly sampling: reduces microstructure noise and turnover vs daily, still enough samples per window (â‰ˆ104 obs) for EM convergence.

---
## ğŸ› ï¸ How to Extend Quickly
Add a new feature (e.g., VIX) snippet inside notebook before model loops:
```python
vix = yf.download('^VIX', start=start_date, end=end_date, progress=False)['Close']
vix_w = np.log(vix.resample('W-FRI').last()).pct_change().rename('VIX_Chg')
df_returns = df_returns.join(vix_w, how='inner')
```
Then modify training slice to include the column and switch to multivariate emissions.

---
## ğŸ“„ License
MIT â€“ see `LICENSE` file.

---
## ğŸ™Œ Acknowledgements
* `hmmlearn` for HMM / GMM-HMM implementations.
* `yfinance` for rapid ETF / index data access.
* Academic / practitioner literature on regime switching & tactical allocation.

---
## ğŸ¤ Contributing
Currently a research prototype. Feel free to fork and open PRs for:
* Reproducible scripts (`src/` package) & tests.
* Parameter search automation.
* Enhanced visualization (regime probability heatmaps, weight dynamics).

---
## ğŸ“¬ Contact
Open an issue or reach out via GitHub profile if you have questions or suggestions.

---
## âœ… TL;DR
Rolling 2â€‘state GMM-HMM on SPY weekly returns allocates to GLD proportional to predicted stress regime probability, improving drawdown efficiency and Sharpe vs SPY and a naive 50/50 mix (within this exploratory study). Further systematic validation & cost modeling advised before real capital deployment.
